<!-- Trade Confirmation Modal (moved to top for z-index and pointer-events fix) -->
<div id="tradeConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center" style="pointer-events:none;">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-auto flex flex-col" style="pointer-events:auto;">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">Confirm Trade Proposal</h3>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div>
        <h4 class="font-semibold text-gray-700 mb-2">You Give:</h4>
        <div id="tradeConfirmGive" class="space-y-1 text-sm"></div>
      </div>
      <div>
        <h4 class="font-semibold text-gray-700 mb-2">You Receive:</h4>
        <div id="tradeConfirmReceive" class="space-y-1 text-sm"></div>
      </div>
    </div>
    <div class="flex space-x-4 justify-center">
      <button id="tradeConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Confirm</button>
      <button id="tradeCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
    </div>
  </div>
</div>
{% extends "web/base.html" %}
{% block title %}Trade Center — {{ team.name }} — NLL Fantasy{% endblock %}
{% block content %}
<div class="container p-2 mx-auto rounded-md sm:p-4 dark:text-gray-800 dark:bg-gray-50">
  <div class="flex items-center justify-between mb-3">
    <div>
      <h2 class="text-2xl font-semibold leading-tight">Trade Center</h2>
      <p class="text-sm text-gray-600">{{ team.name }} — {{ league.name }}</p>
    </div>
    <a href="{% url 'team_detail' team.id %}"
       class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium">
      ← Back to Team
    </a>
  </div>

  <!-- Your Roster -->
  <div class="mb-6 bg-white dark:bg-gray-50 rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-3">Your Roster</h3>
    <div id="your-roster" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
      {% for roster_entry in user_roster %}
      <div class="player-card rounded p-2 cursor-pointer transition-colors border-2
           {% if roster_entry.player.position == 'O' %}bg-green-100 border-green-300 hover:border-green-500
           {% elif roster_entry.player.position == 'D' %}bg-orange-100 border-orange-300 hover:border-orange-500
           {% elif roster_entry.player.position == 'T' %}bg-purple-100 border-purple-300 hover:border-purple-500
           {% else %}bg-blue-100 border-blue-300 hover:border-blue-500{% endif %}"
           data-player-id="{{ roster_entry.player.id }}"
           data-player-name="{{ roster_entry.player.last_name }}, {{ roster_entry.player.first_name }}"
           data-team-name="{{ team.name }}"
           data-team-id="{{ team.id }}"
           onclick="togglePlayerSelection(this, 'your')">
        <div class="font-semibold text-sm">{{ roster_entry.player.last_name }}, {{ roster_entry.player.first_name }}</div>
        <div class="text-xs">
          <span class="inline-block px-1.5 py-0.5 rounded font-semibold
            {% if roster_entry.player.position == 'O' %}text-green-800
            {% elif roster_entry.player.position == 'D' %}text-orange-800
            {% elif roster_entry.player.position == 'T' %}text-purple-800
            {% else %}text-blue-800{% endif %}">
            {{ roster_entry.player.position }}
          </span>
          {{ roster_entry.player.nll_team|default:"—" }}
        </div>
      </div>
      {% endfor %}
    </div>
    
    {# Your Future Picks (Dynasty Leagues) #}
    {% if use_future_picks and user_future_picks %}
    <div class="mt-4 pt-4 border-t border-gray-300">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">Future Picks</h4>
      <div id="your-picks" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
        {% for year in user_future_picks|dictsort %}
        {% with picks_for_year=user_future_picks|get_item:year.0 %}
        {% for pick in picks_for_year %}
        <div class="pick-card rounded p-2 cursor-pointer transition-colors border-2 bg-indigo-100 border-indigo-300 hover:border-indigo-500"
             data-pick-id="{{ pick.id }}"
             data-pick-name="{{ year.0 }} R{{ pick.round_number }}P{{ pick.pick_number }}"
             data-team-name="{{ team.name }}"
             data-team-id="{{ team.id }}"
             onclick="togglePickSelection(this, 'your')">
          <div class="font-semibold text-sm text-indigo-900">{{ year.0 }} R{{ pick.round_number }}</div>
          <div class="text-xs text-indigo-700">Pick {{ pick.pick_number }}</div>
        </div>
        {% endfor %}
        {% endwith %}
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Other Teams -->
  <div class="space-y-6">
    {% for other_team in other_teams %}
    <div class="bg-white dark:bg-gray-50 rounded-lg shadow p-4">
      <h3 class="text-lg font-semibold mb-3">{{ other_team.name }}</h3>
      <div id="team-{{ other_team.id }}-roster" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
        {% for roster_entry in other_team.roster_entries.all %}
        <div class="player-card rounded p-2 cursor-pointer transition-colors border-2
             {% if roster_entry.player.position == 'O' %}bg-green-100 border-green-300 hover:border-green-500
             {% elif roster_entry.player.position == 'D' %}bg-orange-100 border-orange-300 hover:border-orange-500
             {% elif roster_entry.player.position == 'T' %}bg-purple-100 border-purple-300 hover:border-purple-500
             {% else %}bg-blue-100 border-blue-300 hover:border-blue-500{% endif %}"
             data-player-id="{{ roster_entry.player.id }}"
             data-player-name="{{ roster_entry.player.last_name }}, {{ roster_entry.player.first_name }}"
             data-team-name="{{ other_team.name }}"
             data-team-id="{{ other_team.id }}"
             onclick="togglePlayerSelection(this, 'their')">
          <div class="font-semibold text-sm">{{ roster_entry.player.last_name }}, {{ roster_entry.player.first_name }}</div>
          <div class="text-xs">
            <span class="inline-block px-1.5 py-0.5 rounded font-semibold
              {% if roster_entry.player.position == 'O' %}text-green-800
              {% elif roster_entry.player.position == 'D' %}text-orange-800
              {% elif roster_entry.player.position == 'T' %}text-purple-800
              {% else %}text-blue-800{% endif %}">
              {{ roster_entry.player.position }}
            </span>
            {{ roster_entry.player.nll_team|default:"—" }}
          </div>
        </div>
        {% empty %}
        <p class="text-gray-500 italic col-span-full">No players on roster</p>
        {% endfor %}
      </div>
      
      {# Their Future Picks (Dynasty Leagues) #}
      {% if use_future_picks and other_teams_future_picks|get_item:other_team.id %}
      <div class="mt-4 pt-4 border-t border-gray-300">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">Future Picks</h4>
        <div id="team-{{ other_team.id }}-picks" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
          {% for year in other_teams_future_picks|get_item:other_team.id|dictsort %}
          {% with picks_for_year=other_teams_future_picks|get_item:other_team.id|get_item:year.0 %}
          {% for pick in picks_for_year %}
          <div class="pick-card rounded p-2 cursor-pointer transition-colors border-2 bg-indigo-100 border-indigo-300 hover:border-indigo-500"
               data-pick-id="{{ pick.id }}"
               data-pick-name="{{ year.0 }} R{{ pick.round_number }}P{{ pick.pick_number }}"
               data-team-name="{{ other_team.name }}"
               data-team-id="{{ other_team.id }}"
               onclick="togglePickSelection(this, 'their')">
            <div class="font-semibold text-sm text-indigo-900">{{ year.0 }} R{{ pick.round_number }}</div>
            <div class="text-xs text-indigo-700">Pick {{ pick.pick_number }}</div>
          </div>
          {% endfor %}
          {% endwith %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
      
      <div class="mt-4 flex justify-end">
        <button type="button" 
                onclick="proposeTrade({{ other_team.id }})"
                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                id="trade-btn-{{ other_team.id }}"
                disabled>
          Propose Trade
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
let selectedYourPlayers = new Set();
let selectedTheirPlayers = new Map(); // Map of team_id -> Set of player_ids

function togglePlayerSelection(element, type) {
  const playerId = parseInt(element.dataset.playerId);
  const teamId = parseInt(element.dataset.teamId);
  
  if (type === 'your') {
    if (selectedYourPlayers.has(playerId)) {
      selectedYourPlayers.delete(playerId);
      element.classList.remove('ring-4', 'ring-blue-600', 'shadow-lg');
      element.style.filter = '';
    } else {
      selectedYourPlayers.add(playerId);
      element.classList.add('ring-4', 'ring-blue-600', 'shadow-lg');
      element.style.filter = 'brightness(0.85)';
    }
  } else {
    if (!selectedTheirPlayers.has(teamId)) {
      selectedTheirPlayers.set(teamId, new Set());
    }
    const teamSet = selectedTheirPlayers.get(teamId);
    
    if (teamSet.has(playerId)) {
      teamSet.delete(playerId);
      element.classList.remove('ring-4', 'ring-green-600', 'shadow-lg');
      element.style.filter = '';
    } else {
      teamSet.add(playerId);
      element.classList.add('ring-4', 'ring-green-600', 'shadow-lg');
      element.style.filter = 'brightness(0.85)';
    }
  }
  
  updateTradeButtons();
}

function updateTradeButtons() {
  // Enable/disable trade buttons based on selections
  selectedTheirPlayers.forEach((playerSet, teamId) => {
    const btn = document.getElementById(`trade-btn-${teamId}`);
    if (btn) {
      const hasYourPlayers = selectedYourPlayers.size > 0;
      const hasTheirPlayers = playerSet.size > 0;
      btn.disabled = !(hasYourPlayers && hasTheirPlayers);
    }
  });
}

function proposeTrade(targetTeamId) {
  const yourPlayers = Array.from(selectedYourPlayers);
  const theirPlayers = Array.from(selectedTheirPlayers.get(targetTeamId) || []);
  
  if (yourPlayers.length === 0 || theirPlayers.length === 0) {
    alert('Please select at least one player from each team');
    return;
  }
  
  // Get player details
  const yourRosterDiv = document.getElementById('your-roster');
  const theirRosterDiv = document.getElementById('team-' + targetTeamId + '-roster');
  
  const giveList = document.getElementById('tradeConfirmGive');
  const receiveList = document.getElementById('tradeConfirmReceive');
  giveList.innerHTML = '';
  receiveList.innerHTML = '';
  
  // Populate give list
  yourPlayers.forEach(playerId => {
    const card = yourRosterDiv.querySelector(`[data-player-id="${playerId}"]`);
    if (card) {
      const playerName = card.dataset.playerName;
      const teamName = card.dataset.teamName;
      const item = document.createElement('div');
      item.textContent = `${playerName} (${teamName})`;
      giveList.appendChild(item);
    }
  });
  
  // Populate receive list
  theirPlayers.forEach(playerId => {
    const card = theirRosterDiv.querySelector(`[data-player-id="${playerId}"]`);
    if (card) {
      const playerName = card.dataset.playerName;
      const teamName = card.dataset.teamName;
      const item = document.createElement('div');
      item.textContent = `${playerName} (${teamName})`;
      receiveList.appendChild(item);
    }
  });
  
  // Show custom modal for trade confirmation
  const modal = document.getElementById('tradeConfirmModal');
  modal.classList.remove('hidden');
  modal.style.pointerEvents = 'auto';

  // Set up confirm button handler
  const confirmBtn = document.getElementById('tradeConfirmBtn');
  const cancelBtn = document.getElementById('tradeCancelBtn');

  // Remove previous listeners
  confirmBtn.onclick = null;
  cancelBtn.onclick = null;

  confirmBtn.onclick = function() {
    modal.classList.add('hidden');
    modal.style.pointerEvents = 'none';
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "propose_trade" team.id %}';
    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);
    // Add target team ID
    const targetTeamInput = document.createElement('input');
    targetTeamInput.type = 'hidden';
    targetTeamInput.name = 'target_team_id';
    targetTeamInput.value = targetTeamId;
    form.appendChild(targetTeamInput);
    // Add your players
    const yourPlayersInput = document.createElement('input');
    yourPlayersInput.type = 'hidden';
    yourPlayersInput.name = 'your_players';
    yourPlayersInput.value = JSON.stringify(yourPlayers);
    form.appendChild(yourPlayersInput);
    // Add their players
    const theirPlayersInput = document.createElement('input');
    theirPlayersInput.type = 'hidden';
    theirPlayersInput.name = 'their_players';
    theirPlayersInput.value = JSON.stringify(theirPlayers);
    form.appendChild(theirPlayersInput);
    // Submit form
    document.body.appendChild(form);
    form.submit();
  };
  cancelBtn.onclick = function() {
    modal.classList.add('hidden');
    modal.style.pointerEvents = 'none';
  };
}
</script>
{% endblock %}
