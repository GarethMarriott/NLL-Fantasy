{% extends "web/base.html" %}

{% block title %}
  {% if chat_type == 'league' %}League Chat{% else %}Team Chat with {{ current_chat_with.name }}{% endif %} - NLL Fantasy
{% endblock %}

{% block content %}
<!-- Hide Django messages -->
<style>
  #toast-container { display: none !important; }
  .messages { display: none !important; }
</style>

<div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between mb-2">
      <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
          {% if chat_type == 'league' %}
            League Chat
          {% else %}
            Team Chat: {{ current_chat_with.name }}
          {% endif %}
        </h2>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          {% if chat_type == 'league' %}
            Chat with other team owners and see league activity
          {% else %}
            Private chat about trades and team matters
          {% endif %}
        </p>
      </div>
    </div>
    
    <!-- Chat Selector Tabs -->
    <div class="flex flex-wrap gap-2 mt-4">
      <a href="{% url 'chat' %}?chat_type=league" 
         class="px-4 py-2 rounded-lg {% if chat_type == 'league' %}bg-blue-500 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600{% endif %}">
        üèüÔ∏è League Chat
      </a>
      
      {% if available_team_chats %}
        {% for team in available_team_chats %}
          <a href="{% url 'chat' %}?chat_type=team&team_chat_id={{ team.id }}" 
             class="px-4 py-2 rounded-lg {% if chat_type == 'team' and current_chat_with.id == team.id %}bg-green-500 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600{% endif %}">
            ü§ù {{ team.name }}
          </a>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <!-- Messages Container -->
  <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900">
    {% for msg in messages reversed %}
      {% if not is_team_chat or msg.message_type not in "ADD|DROP|SYSTEM" %}
      <div class="flex items-start space-x-3" data-message-id="{{ msg.id }}">
        {% if msg.sender %}
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-bold">
              {{ msg.sender.username|slice:":1"|upper }}
            </div>
          </div>
        {% else %}
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white text-sm">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
            </div>
          </div>
        {% endif %}
        
        <div class="flex-1 min-w-0">
          <div class="flex items-baseline space-x-2">
            {% if msg.sender %}
              <span class="font-semibold text-gray-900 dark:text-white">{{ msg.sender.username }}</span>
              {% if msg.sender.fantasyteamowner_set.exists %}
                <span class="text-xs text-gray-500 dark:text-gray-400">
                  ({% for owner in msg.sender.fantasyteamowner_set.all %}{{ owner.team.name }}{% if not forloop.last %}, {% endif %}{% endfor %})
                </span>
              {% endif %}
            {% else %}
                {% if msg.message_type == 'ADD' or msg.message_type == 'DROP' %}
                  <span class="font-semibold text-gray-900 dark:text-white">‚ö° {{ msg.player|default:"System" }}</span>
                {% else %}
                  <span class="font-semibold text-gray-600 dark:text-gray-400">System</span>
                {% endif %}
                {% if msg.player_dropped %}
                  <span class="inline-block bg-red-500 text-white px-3 py-1 rounded font-semibold ml-2">
                    - {{ msg.player_dropped.first_name|slice:":1" }}. {{ msg.player_dropped.last_name }}
                  </span>
                {% endif %}
              </div>
            {% elif msg.message_type == 'DROP' %}
              {% if msg.player %}
                <span class="inline-block bg-red-500 text-white px-3 py-1 rounded font-semibold">
                  - {{ msg.player.first_name|slice:":1" }}. {{ msg.player.last_name }}
                </span>
              {% else %}
                {{ msg.message }}
              {% endif %}
            {% elif 'TRADE' in msg.message_type %}
              <span class="inline-block bg-purple-500 text-white px-3 py-1 rounded font-semibold">
                üì¶ {{ msg.message }}
              </span>
            {% else %}
              {{ msg.message }}
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% empty %}
      <p class="text-center text-gray-500 dark:text-gray-400 py-8">No messages yet. Start the conversation!</p>
    {% endfor %}
  </div>

  <!-- Message Input -->
  <div class="p-4 border-t border-gray-200 dark:border-gray-700">
    <form id="chat-form" class="flex space-x-3">
      {% csrf_token %}
      <input type="hidden" id="chat-type" name="chat_type" value="{{ chat_type }}">
      {% if current_chat_with %}
        <input type="hidden" id="team-chat-id" name="team_chat_id" value="{{ current_chat_with.id }}">
      {% endif %}
      <input type="text" 
             id="chat-input" 
             name="message"
             placeholder="Type your message..." 
             class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
             maxlength="1000"
             required>
      <button type="submit" 
              class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        Send
      </button>
    </form>
  </div>
</div>

<script>
// Get the last message ID from the DOM to ensure we skip initial messages
function getLastMessageIdFromDOM() {
  const messages = document.querySelectorAll('#chat-messages > div');
  if (messages.length > 0) {
    const lastMsg = messages[messages.length - 1];
    const dataId = lastMsg.getAttribute('data-message-id');
    return dataId ? parseInt(dataId) : 0;
  }
  return 0;
}

let lastMessageId = {{ messages.first.id|default:0 }};
let chatType = '{{ chat_type }}';
let teamChatId = {% if current_chat_with %}'{{ current_chat_with.id }}'{% else %}null{% endif %};

// Auto-refresh messages every 3 seconds
setInterval(function() {
  // Update lastMessageId from DOM before fetching
  lastMessageId = getLastMessageIdFromDOM();
  fetchNewMessages();
}, 3000);

function fetchNewMessages() {
  let url = `/chat/messages/?since=${lastMessageId}&chat_type=${chatType}`;
  if (chatType === 'team' && teamChatId) {
    url += `&team_chat_id=${teamChatId}`;
  }
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(addMessageToChat);
        lastMessageId = data.messages[data.messages.length - 1].id;
        
        // Scroll to bottom
        const chatContainer = document.getElementById('chat-messages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    })
    .catch(error => console.error('Error fetching messages:', error));
}

function addMessageToChat(msg) {
  const chatContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'flex items-start space-x-3';
  messageDiv.setAttribute('data-message-id', msg.id);
  
  const senderInitial = msg.is_system ? '!' : msg.sender.charAt(0).toUpperCase();
  const senderClass = msg.is_system ? 'bg-gray-500' : 'bg-blue-500';
  // For ADD/DROP messages, show team name; otherwise show sender name
  const senderName = (msg.message_type === 'ADD' || msg.message_type === 'DROP') ? msg.sender : msg.sender;
  const teamInfo = msg.team ? `<span class="text-xs text-gray-500 dark:text-gray-400">(${msg.team})</span>` : '';
  
  const date = new Date(msg.created_at);
  const timeStr = date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  
  let messageClass = 'mt-1 text-sm text-gray-700 dark:text-gray-300';
  let messageContent = msg.message;
  
  if (msg.message_type === 'ADD' && msg.player) {
    // Player name comes as "First Last" from the API
    const parts = msg.player.trim().split(' ');
    const firstName = parts[0];
    const lastName = parts.slice(1).join(' ') || '';
    const initial = firstName.charAt(0).toUpperCase();
    let content = `<span class="inline-block bg-green-500 text-white px-3 py-1 rounded font-semibold">+ ${initial}. ${lastName}</span>`;
    
    // Add dropped player if available
    if (msg.player_dropped) {
      const droppedParts = msg.player_dropped.trim().split(' ');
      const droppedFirstName = droppedParts[0];
      const droppedLastName = droppedParts.slice(1).join(' ') || '';
      const droppedInitial = droppedFirstName.charAt(0).toUpperCase();
      content += ` <span class="inline-block bg-red-500 text-white px-3 py-1 rounded font-semibold">- ${droppedInitial}. ${droppedLastName}</span>`;
    }
    messageContent = content;
  } else if (msg.message_type === 'DROP' && msg.player) {
    const parts = msg.player.trim().split(' ');
    const firstName = parts[0];
    const lastName = parts.slice(1).join(' ') || '';
    const initial = firstName.charAt(0).toUpperCase();
    messageContent = `<span class="inline-block bg-red-500 text-white px-3 py-1 rounded font-semibold">- ${initial}. ${lastName}</span>`;
  } else if (msg.message_type && msg.message_type.includes('TRADE')) {
    messageContent = `<span class="inline-block bg-purple-500 text-white px-3 py-1 rounded font-semibold">üì¶ ${msg.message}</span>`;
  }
  
  messageDiv.innerHTML = `
    <div class="flex-shrink-0">
      <div class="w-8 h-8 rounded-full ${senderClass} flex items-center justify-center text-white text-sm font-bold">
        ${senderInitial}
      </div>
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-baseline space-x-2">
        <span class="font-semibold text-gray-900 dark:text-white">${senderName}</span>
        ${teamInfo}
        <span class="text-xs text-gray-500 dark:text-gray-400">${timeStr}</span>
      </div>
      <div class="${messageClass}">${messageContent}</div>
    </div>
  `;
  
  chatContainer.appendChild(messageDiv);
}

// Handle form submission
document.getElementById('chat-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  const formData = new FormData(this);
  
  fetch('/chat/post/', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      input.value = '';
      // Fetch messages immediately to show the new one
      setTimeout(fetchNewMessages, 100);
    }
  })
  .catch(error => console.error('Error posting message:', error));
});

// Scroll to bottom on load
window.addEventListener('load', function() {
  const chatContainer = document.getElementById('chat-messages');
  chatContainer.scrollTop = chatContainer.scrollHeight;
});
</script>
{% endblock %}
