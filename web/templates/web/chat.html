{% extends "web/base.html" %}

{% block title %}League Chat - NLL Fantasy{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">League Chat</h2>
    <p class="text-sm text-gray-600 dark:text-gray-400">Chat with other team owners and see league activity</p>
  </div>

  <!-- Messages Container -->
  <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900">
    {% for msg in messages reversed %}
      <div class="flex items-start space-x-3">
        {% if msg.sender %}
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-bold">
              {{ msg.sender.username|slice:":1"|upper }}
            </div>
          </div>
        {% else %}
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white text-sm">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
            </div>
          </div>
        {% endif %}
        
        <div class="flex-1 min-w-0">
          <div class="flex items-baseline space-x-2">
            {% if msg.sender %}
              <span class="font-semibold text-gray-900 dark:text-white">{{ msg.sender.username }}</span>
              {% if msg.sender.fantasy_owner %}
                <span class="text-xs text-gray-500 dark:text-gray-400">({{ msg.sender.fantasy_owner.team.name }})</span>
              {% endif %}
            {% else %}
              <span class="font-semibold text-gray-600 dark:text-gray-400">System</span>
            {% endif %}
            <span class="text-xs text-gray-500 dark:text-gray-400">{{ msg.created_at|date:"M d, g:i A" }}</span>
          </div>
          
          <div class="mt-1 text-sm text-gray-700 dark:text-gray-300 
                      {% if msg.message_type == 'ADD' %}bg-green-100 dark:bg-green-900 p-2 rounded{% endif %}
                      {% if msg.message_type == 'DROP' %}bg-red-100 dark:bg-red-900 p-2 rounded{% endif %}">
            {{ msg.message }}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-gray-500 dark:text-gray-400 py-8">No messages yet. Start the conversation!</p>
    {% endfor %}
  </div>

  <!-- Message Input -->
  <div class="p-4 border-t border-gray-200 dark:border-gray-700">
    <form id="chat-form" class="flex space-x-3">
      {% csrf_token %}
      <input type="text" 
             id="chat-input" 
             name="message"
             placeholder="Type your message..." 
             class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
             maxlength="1000"
             required>
      <button type="submit" 
              class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        Send
      </button>
    </form>
  </div>
</div>

<script>
let lastMessageId = {{ messages.first.id|default:0 }};

// Auto-refresh messages every 3 seconds
setInterval(fetchNewMessages, 3000);

function fetchNewMessages() {
  fetch(`/chat/messages/?since=${lastMessageId}`)
    .then(response => response.json())
    .then(data => {
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(addMessageToChat);
        lastMessageId = data.messages[data.messages.length - 1].id;
        
        // Scroll to bottom
        const chatContainer = document.getElementById('chat-messages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    })
    .catch(error => console.error('Error fetching messages:', error));
}

function addMessageToChat(msg) {
  const chatContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'flex items-start space-x-3';
  
  const senderInitial = msg.is_system ? '!' : msg.sender.charAt(0).toUpperCase();
  const senderClass = msg.is_system ? 'bg-gray-500' : 'bg-blue-500';
  const senderName = msg.is_system ? 'System' : msg.sender;
  const teamInfo = msg.team ? `<span class="text-xs text-gray-500 dark:text-gray-400">(${msg.team})</span>` : '';
  
  const date = new Date(msg.created_at);
  const timeStr = date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  
  let messageClass = 'mt-1 text-sm text-gray-700 dark:text-gray-300';
  if (msg.message_type === 'ADD') messageClass += ' bg-green-100 dark:bg-green-900 p-2 rounded';
  if (msg.message_type === 'DROP') messageClass += ' bg-red-100 dark:bg-red-900 p-2 rounded';
  
  messageDiv.innerHTML = `
    <div class="flex-shrink-0">
      <div class="w-8 h-8 rounded-full ${senderClass} flex items-center justify-center text-white text-sm font-bold">
        ${senderInitial}
      </div>
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-baseline space-x-2">
        <span class="font-semibold text-gray-900 dark:text-white">${senderName}</span>
        ${teamInfo}
        <span class="text-xs text-gray-500 dark:text-gray-400">${timeStr}</span>
      </div>
      <div class="${messageClass}">${msg.message}</div>
    </div>
  `;
  
  chatContainer.appendChild(messageDiv);
}

// Handle form submission
document.getElementById('chat-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  const formData = new FormData(this);
  
  fetch('/chat/post/', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      input.value = '';
      // Fetch messages immediately to show the new one
      setTimeout(fetchNewMessages, 100);
    }
  })
  .catch(error => console.error('Error posting message:', error));
});

// Scroll to bottom on load
window.addEventListener('load', function() {
  const chatContainer = document.getElementById('chat-messages');
  chatContainer.scrollTop = chatContainer.scrollHeight;
});
</script>
{% endblock %}
