{% extends "web/base.html" %}
{% block title %}Players — NLL Fantasy{% endblock %}
{% block content %}
  <div class="container p-2 mx-auto rounded-md sm:p-4 dark:text-gray-800 dark:bg-gray-50">
    <h2 class="mb-3 text-2xl font-semibold leading-tight">Players</h2>

    <div class="flex items-center justify-between mb-4">
      <div class="hidden sm:block">
        {% if selected_season %}
          <h3 class="text-lg font-semibold text-gray-800">
            {{ selected_season }} Season
            {% if selected_week_num %}
              — Week {{ selected_week_num }}
            {% else %}
              — {% if selected_stat_type == 'playoff' %}Playoff{% elif selected_stat_type == 'all' %}All Games{% else %}Regular Season{% endif %} Totals
            {% endif %}
          </h3>
        {% endif %}
      </div>
      <form method="get" class="grid grid-cols-2 gap-2 sm:flex sm:flex-row sm:items-center sm:gap-3 w-full sm:w-auto">
        <div class="flex items-center col-span-2 sm:col-span-1">
          <label for="search" class="inline sm:hidden mr-2 text-sm font-medium">Search:</label>
          <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Player name..." class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex items-center">
          <label for="position" class="inline sm:hidden mr-2 text-sm font-medium">Position:</label>
          <select name="position" id="position" onchange="this.form.submit()" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Runners</option>
            <option value="O" {% if selected_position == 'O' %}selected{% endif %}>Offense</option>
            <option value="D" {% if selected_position == 'D' %}selected{% endif %}>Defense</option>
            <option value="T" {% if selected_position == 'T' %}selected{% endif %}>Transition</option>
            <option value="G" {% if selected_position == 'G' %}selected{% endif %}>Goalie</option>
          </select>
        </div>
        <div class="flex items-center">
          <label for="season" class="inline sm:hidden mr-2 text-sm font-medium">Season:</label>
          <select name="season" id="season" onchange="this.form.submit()" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            {% for s in seasons %}
              <option value="{{ s }}" {% if selected_season and s|stringformat:"s" == selected_season %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center">
          <label for="week" class="inline sm:hidden mr-2 text-sm font-medium">Week:</label>
          <select name="week" id="week" onchange="this.form.submit()" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All</option>
            {% for wk in week_options %}
              <option value="{{ wk.week_number }}" {% if selected_week_num and wk.week_number|stringformat:"s" == selected_week_num %}selected{% endif %}>
                Week {{ wk.week_number }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center">
          <label for="stat_type" class="inline sm:hidden mr-2 text-sm font-medium">Type:</label>
          <select name="stat_type" id="stat_type" onchange="this.form.submit()" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="regular" {% if selected_stat_type == 'regular' %}selected{% endif %}>Regular</option>
            <option value="playoff" {% if selected_stat_type == 'playoff' %}selected{% endif %}>Playoff</option>
            <option value="all" {% if selected_stat_type == 'all' %}selected{% endif %}>All</option>
          </select>
        </div>
        <input type="hidden" name="sort" value="{{ sort_field }}">
        <input type="hidden" name="dir" value="{{ sort_dir }}">
        <button type="submit" class="col-span-2 sm:col-span-1 px-3 py-1 bg-blue-500 text-white rounded-md text-xs sm:text-sm hover:bg-blue-600">Search</button>
      </form>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead class="rounded-t-lg dark:bg-gray-300">
          <tr class="text-right">
            {% if user_team %}
            <th title="Status / Action" class="p-3" style="width: 80px;"></th>
            {% endif %}
            <th title="Rank" class="p-3 text-center" style="width: 40px;">
              Rank
            </th>
            <th title="Player name" class="p-3 text-left">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=name&dir={% if sort_field == 'name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                Name
              </a>
            </th>
            <th title="NLL Team" class="p-3 text-left hidden">Team</th>
            <th title="Jersey number" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=number&dir={% if sort_field == 'number' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                #
              </a>
            </th>
            <th title="Position" class="p-2" style="width: 40px;">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=position&dir={% if sort_field == 'position' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                Pos
              </a>
            </th>
            <th title="Games played" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=gp&dir={% if sort_field == 'gp' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                GP
              </a>
            </th>
            <th title="Fantasy points" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=fpts&dir={% if sort_field == 'fpts' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                FPTS
              </a>
            </th>
            <th title="Fantasy points per game" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&stat_type={{ selected_stat_type }}&sort=ppg&dir={% if sort_field == 'ppg' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                PPG
              </a>
            </th>
            {% if selected_position == 'G' %}
            <th title="Wins" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=wins&dir={% if sort_field == 'wins' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                W
              </a>
            </th>
            <th title="Saves" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=saves&dir={% if sort_field == 'saves' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                SV
              </a>
            </th>
            <th title="Goals against" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=ga&dir={% if sort_field == 'ga' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                GA
              </a>
            </th>
            <th title="Save percentage" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=sv_pct&dir={% if sort_field == 'sv_pct' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                SV%
              </a>
            </th>
            <th title="Goals" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=goals&dir={% if sort_field == 'goals' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                G
              </a>
            </th>
            <th title="Assists" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=assists&dir={% if sort_field == 'assists' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                A
              </a>
            </th>
            {% else %}
            <th title="Goals" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=goals&dir={% if sort_field == 'goals' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                G
              </a>
            </th>
            <th title="Assists" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=assists&dir={% if sort_field == 'assists' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                A
              </a>
            </th>
            <th title="Loose balls" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=loose&dir={% if sort_field == 'loose' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                LB
              </a>
            </th>
            <th title="Caused turnovers" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=ct&dir={% if sort_field == 'ct' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                CT
              </a>
            </th>
            <th title="Blocked shots" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=bs&dir={% if sort_field == 'bs' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                BS
              </a>
            </th>
            <th title="Turnovers" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=to&dir={% if sort_field == 'to' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                TO
              </a>
            </th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
        {% for item in players %}
          {% with player=item.player stat=item.latest_stat %}
          <tr class="text-right border-b border-opacity-20 dark:border-gray-300 dark:bg-gray-100">
            {% if user_team %}
            <td class="px-2 py-2">
              {% if item.roster_status == 'on_your_team' %}
                <div class="block px-2 py-1 bg-blue-500 text-white rounded text-xs font-semibold whitespace-nowrap text-center w-20" title="On your team">Your Team</div>
              {% elif item.roster_status == 'on_other_team' %}
                <div class="block px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold whitespace-nowrap text-center w-20" title="On {{ item.rostered_team.name }}">Rostered</div>
              {% elif item.roster_status == 'available' %}
                {% if roster_can_change %}
                  <div class="block px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold whitespace-nowrap text-center w-20 cursor-pointer hover:bg-green-600"
                    onclick="showReplaceOptions({{ player.id }}, '{{ player.first_name }} {{ player.last_name }}', '{{ player.position }}')"
                    title="Add player">
                    Add
                  </div>
                {% elif use_waivers %}
                  <div class="block px-2 py-1 bg-yellow-500 text-white rounded text-xs font-semibold whitespace-nowrap text-center w-20 cursor-pointer hover:bg-yellow-600"
                    onclick="showWaiverOptions({{ player.id }}, '{{ player.first_name }} {{ player.last_name }}', '{{ player.position }}')"
                    title="Submit waiver claim">
                    Waiver
                  </div>
                {% endif %}
              {% endif %}
            </td>
            {% endif %}
            <td class="px-3 py-2 text-center font-semibold text-blue-600">
              {{ item.rank }}
            </td>
            <td class="px-3 py-2 text-left">
              <div class="cursor-pointer hover:text-blue-600 hover:underline" onclick="showPlayerModal({{ player.id }}, '{{ player.first_name }} {{ player.last_name }}')">
                <div class="font-semibold">{{ player.last_name }}, {{ player.first_name }}</div>
                {% if player.nll_team %}<div class="text-xs text-gray-600">{{ player.nll_team }}</div>{% endif %}
              </div>
            </td>
            <td class="px-3 py-2 text-left hidden">
              <span class="text-xs">{{ player.nll_team|default:"-" }}</span>
            </td>
            <td class="px-3 py-2">
              <span>{{ player.number|default:"-" }}</span>
            </td>
            <td class="px-2 py-2">
              <span>{{ player.position }}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if item.games_played %}{{ item.games_played }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span class="font-bold">{% if item.fantasy_points %}{{ item.fantasy_points|floatformat:1 }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span class="font-bold">{% if item.ppg %}{{ item.ppg|floatformat:2 }}{% else %}-{% endif %}</span>
            </td>
            {% if selected_position == 'G' %}
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.wins }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.saves }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals_against }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat and stat.saves > 0 %}{% widthratio stat.saves stat.saves|add:stat.goals_against 100 %}%{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.assists }}{% else %}-{% endif %}</span>
            </td>
            {% else %}
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.assists }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.loose_balls }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.caused_turnovers }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.blocked_shots }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.turnovers }}{% else %}-{% endif %}</span>
            </td>
            {% endif %}
          </tr>
          {% endwith %}
        {% empty %}
          <tr class="border-b border-opacity-20 dark:border-gray-300 dark:bg-gray-100">
            <td colspan="{% if user_team %}{% if selected_position == 'G' %}14{% else %}14{% endif %}{% else %}{% if selected_position == 'G' %}13{% else %}13{% endif %}{% endif %}" class="px-3 py-2 text-center text-gray-500">No players found.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if user_team %}
  <!-- Modal for selecting player to replace -->
  <div id="replaceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold mb-4">Add <span id="newPlayerName"></span></h3>
      <p class="mb-4 text-sm text-gray-600">Select a player to drop from your roster:</p>
      <div id="replaceOptions" class="space-y-2 mb-4">
        <!-- Options will be populated by JavaScript -->
      </div>
      <button onclick="closeReplaceModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
        Cancel
      </button>
    </div>
  </div>

  <!-- Modal for waiver claims -->
  <div id="waiverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold mb-4">Waiver Claim: <span id="waiverPlayerName"></span></h3>
      <p class="mb-4 text-sm text-gray-600">Rosters are locked. Select a player to drop (optional). Claim will process on Monday at 9 AM.</p>
      <div id="waiverOptions" class="space-y-2 mb-4">
        <!-- Options will be populated by JavaScript -->
      </div>
      <button onclick="closeWaiverModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
        Cancel
      </button>
    </div>
  </div>

  <script>
    function showReplaceOptions(newPlayerId, newPlayerName, newPlayerPosition) {
      document.getElementById('newPlayerName').textContent = newPlayerName;
      const optionsDiv = document.getElementById('replaceOptions');
      optionsDiv.innerHTML = '';

      // Get roster for this position
      const roster = {{ user_roster_json|safe }};
      let positionRoster = roster[newPlayerPosition] || [];
      
      // For transition players, also include O and D players
      if (newPlayerPosition === 'T') {
        const offenseRoster = roster['O'] || [];
        const defenseRoster = roster['D'] || [];
        // Combine and deduplicate by ID
        const combined = [...positionRoster, ...offenseRoster, ...defenseRoster];
        const seen = new Set();
        positionRoster = combined.filter(p => {
          if (seen.has(p.id)) return false;
          seen.add(p.id);
          return true;
        });
      }

      // Check if roster is full
      const rosterCount = {{ roster_count }};
      const rosterMax = {{ roster_max }};
      const hasSpace = rosterCount < rosterMax;

      // Add "Add without dropping" option if roster isn't full
      if (hasSpace) {
        const addButton = document.createElement('button');
        addButton.className = 'w-full px-4 py-2 text-left bg-green-100 hover:bg-green-200 rounded border border-green-400 font-semibold text-green-800';
        addButton.textContent = `Add ${newPlayerName} (${rosterCount}/${rosterMax})`;
        addButton.onclick = () => addPlayerDirect(newPlayerId, newPlayerPosition);
        optionsDiv.appendChild(addButton);
        
        // Add separator if there are also players to swap
        if (positionRoster.length > 0) {
          const separator = document.createElement('div');
          separator.className = 'text-center text-xs text-gray-500 my-2';
          separator.textContent = 'OR';
          optionsDiv.appendChild(separator);
        }
      }

      if (positionRoster.length === 0 && !hasSpace) {
        optionsDiv.innerHTML = '<p class="text-sm text-red-500">Roster is full. No players in this position to replace.</p>';
      } else if (positionRoster.length > 0) {
        positionRoster.forEach(player => {
          const button = document.createElement('button');
          button.className = 'w-full px-4 py-2 text-left bg-gray-100 hover:bg-gray-200 rounded border border-gray-300';
          button.textContent = `Drop ${player.first_name} ${player.last_name}`;
          button.onclick = () => swapPlayer(newPlayerId, player.id);
          optionsDiv.appendChild(button);
        });
      }

      document.getElementById('replaceModal').classList.remove('hidden');
      document.getElementById('replaceModal').classList.add('flex');
    }

    function closeReplaceModal() {
      document.getElementById('replaceModal').classList.add('hidden');
      document.getElementById('replaceModal').classList.remove('flex');
    }

    function showWaiverOptions(newPlayerId, newPlayerName, newPlayerPosition) {
      document.getElementById('waiverPlayerName').textContent = newPlayerName;
      const optionsDiv = document.getElementById('waiverOptions');
      optionsDiv.innerHTML = '';

      // Get roster for this position
      const roster = {{ user_roster_json|safe }};
      let positionRoster = roster[newPlayerPosition] || [];
      
      // For transition players, also include O and D players
      if (newPlayerPosition === 'T') {
        const offenseRoster = roster['O'] || [];
        const defenseRoster = roster['D'] || [];
        const combined = [...offenseRoster, ...defenseRoster];
        const seen = new Set();
        positionRoster = combined.filter(p => {
          if (seen.has(p.id)) return false;
          seen.add(p.id);
          return true;
        });
      }

      // Add option to claim without dropping
      const addButton = document.createElement('button');
      addButton.className = 'w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 font-semibold';
      addButton.textContent = 'Claim (no drop)';
      addButton.onclick = () => submitWaiverClaim(newPlayerId, null);
      optionsDiv.appendChild(addButton);

      // Add separator if there are players to drop
      if (positionRoster.length > 0) {
        const separator = document.createElement('div');
        separator.className = 'text-center text-xs text-gray-500 my-2';
        separator.textContent = 'OR DROP A PLAYER';
        optionsDiv.appendChild(separator);

        positionRoster.forEach(player => {
          const button = document.createElement('button');
          button.className = 'w-full px-4 py-2 text-left bg-gray-100 hover:bg-gray-200 rounded border border-gray-300';
          // Include position in the button text
          const positionBadge = `<span class="inline-block px-2 py-0.5 mr-2 text-xs font-semibold rounded ${
            player.position === 'O' ? 'bg-green-100 text-green-800 border border-green-300' :
            player.position === 'D' ? 'bg-orange-100 text-orange-800 border border-orange-300' :
            player.position === 'G' ? 'bg-blue-100 text-blue-800 border border-blue-300' :
            'bg-gray-100 text-gray-800 border border-gray-300'
          }">${player.position}</span>`;
          button.innerHTML = `${positionBadge}${player.first_name} ${player.last_name} ${player.number ? '#' + player.number : ''}`;
          button.onclick = () => submitWaiverClaim(newPlayerId, player.id);
          optionsDiv.appendChild(button);
        });
      }

      document.getElementById('waiverModal').classList.remove('hidden');
      document.getElementById('waiverModal').classList.add('flex');
    }

    function closeWaiverModal() {
      document.getElementById('waiverModal').classList.add('hidden');
      document.getElementById('waiverModal').classList.remove('flex');
    }

    function submitWaiverClaim(addPlayerId, dropPlayerId) {
      // Create form and submit
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/teams/{{ user_team.id }}/waiver-claim/';
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = '{{ csrf_token }}';
      
      const addInput = document.createElement('input');
      addInput.type = 'hidden';
      addInput.name = 'player_to_add_id';
      addInput.value = addPlayerId;
      
      if (dropPlayerId) {
        const dropInput = document.createElement('input');
        dropInput.type = 'hidden';
        dropInput.name = 'player_to_drop_id';
        dropInput.value = dropPlayerId;
        form.appendChild(dropInput);
      }
      
      form.appendChild(csrfInput);
      form.appendChild(addInput);
      document.body.appendChild(form);
      form.submit();
    }


    function closeModal(event) {
      if (event.target.id === 'replaceModal') {
        closeReplaceModal();
      }
    }

    function addPlayerDirect(playerId, position) {
      // Create form and submit for direct add (no drop)
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/teams/{{ user_team.id }}/assign-player/';
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = '{{ csrf_token }}';
      
      const playerInput = document.createElement('input');
      playerInput.type = 'hidden';
      playerInput.name = 'player_id';
      playerInput.value = playerId;
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'add';
      
      const slotInput = document.createElement('input');
      slotInput.type = 'hidden';
      slotInput.name = 'slot_group';
      // Determine slot group based on position
      if (position === 'G') {
        slotInput.value = 'G';
      } else if (position === 'D') {
        slotInput.value = 'D';
      } else {
        slotInput.value = 'O'; // O or T goes to offense
      }
      
      form.appendChild(csrfInput);
      form.appendChild(playerInput);
      form.appendChild(actionInput);
      form.appendChild(slotInput);
      document.body.appendChild(form);
      form.submit();
    }

    function swapPlayer(addPlayerId, dropPlayerId) {
      // Create form and submit
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/teams/{{ user_team.id }}/assign-player/';
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = '{{ csrf_token }}';
      
      const addInput = document.createElement('input');
      addInput.type = 'hidden';
      addInput.name = 'player_id';
      addInput.value = addPlayerId;
      
      const dropInput = document.createElement('input');
      dropInput.type = 'hidden';
      dropInput.name = 'drop_player_id';
      dropInput.value = dropPlayerId;
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'swap';
      
      form.appendChild(csrfInput);
      form.appendChild(addInput);
      form.appendChild(dropInput);
      form.appendChild(actionInput);
      document.body.appendChild(form);
      form.submit();
    }
  </script>

  <!-- Player Detail Modal -->
  <div id="playerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto" onclick="closePlayerModal(event)">
    <div class="bg-white rounded-lg overflow-hidden max-w-2xl w-full mx-4 my-8" onclick="event.stopPropagation()">
      <!-- Header with position color -->
      <div id="playerModalHeader" class="bg-gray-100 px-6 py-4 flex justify-between items-center">
        <h2 class="text-2xl font-semibold" id="playerModalTitle"></h2>
        <button onclick="closePlayerModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="p-6">
        <!-- Player Bio Section -->
        <div id="playerBioSection" class="mb-6 pb-6 border-b border-gray-300">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="font-semibold text-gray-600">Number:</span>
              <div id="playerNumber">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Position:</span>
              <div id="playerPosition">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">NLL Team:</span>
              <div id="playerNLLTeam">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Shoots:</span>
              <div id="playerShoots">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Height:</span>
              <div id="playerHeight">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Weight:</span>
              <div id="playerWeight">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Hometown:</span>
              <div id="playerHometown">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Draft Year:</span>
              <div id="playerDraftYear">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-600">Birthdate:</span>
              <div id="playerBirthdate">-</div>
            </div>
          </div>
        </div>
        
        <!-- Upcoming Schedule Section -->
        <div id="scheduleSection" class="mb-6 pb-6 border-b border-gray-300">
          <h3 class="text-lg font-semibold mb-3">Upcoming Schedule</h3>
          <div id="scheduleContainer" class="space-y-2">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Stats by Week Section -->
        <div id="statsSection">
          <h3 class="text-lg font-semibold mb-4">Stats by Week</h3>
          <div id="weekStatsContainer" class="space-y-4 max-h-96 overflow-y-auto">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function getPositionColor(position) {
      switch(position) {
        case 'O':
          return 'bg-green-100 text-green-800';
        case 'D':
          return 'bg-orange-100 text-orange-800';
        case 'G':
          return 'bg-blue-100 text-blue-800';
        case 'T':
          return 'bg-purple-100 text-purple-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    function showPlayerModal(playerId, playerName) {
      // Fetch player data from AJAX endpoint
      fetch(`/players/${playerId}/modal/`)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load player data');
          return response.json();
        })
        .then(data => {
          // Populate player bio
          document.getElementById('playerModalTitle').textContent = data.player.name;
          document.getElementById('playerNumber').textContent = data.player.number || '-';
          document.getElementById('playerPosition').textContent = data.player.position || '-';
          document.getElementById('playerNLLTeam').textContent = data.player.nll_team || '-';
          document.getElementById('playerShoots').textContent = data.player.shoots || '-';
          document.getElementById('playerHeight').textContent = data.player.height || '-';
          document.getElementById('playerWeight').textContent = data.player.weight ? `${data.player.weight} lbs` : '-';
          document.getElementById('playerHometown').textContent = data.player.hometown || '-';
          document.getElementById('playerDraftYear').textContent = data.player.draft_year || '-';
          document.getElementById('playerBirthdate').textContent = data.player.birthdate || '-';
          
          // Apply position color to header
          const positionLetter = data.player.position ? data.player.position.charAt(0).toUpperCase() : '';
          const headerElement = document.getElementById('playerModalHeader');
          headerElement.className = `${getPositionColor(positionLetter)} px-6 py-4 flex justify-between items-center`;
          
          // Populate week stats (including upcoming weeks)
          const container = document.getElementById('weekStatsContainer');
          container.innerHTML = '';
          
          if (data.week_stats && data.week_stats.length > 0) {
            data.week_stats.forEach(week => {
              const weekDiv = document.createElement('div');
              weekDiv.className = 'bg-gray-50 rounded p-4 border border-gray-200';
              
              if (week.is_upcoming) {
                // Upcoming week - show schedule
                let scheduleHTML = `<div class="font-semibold text-gray-800 mb-2">${week.week}`;
                if (week.games_count === 0) {
                  scheduleHTML += ` <span class="text-orange-600 font-semibold">(BYE)</span>`;
                } else {
                  scheduleHTML += ` <span class="text-green-600 font-semibold">(${week.games_count} Game${week.games_count !== 1 ? 's' : ''})</span>`;
                }
                scheduleHTML += '</div>';
                
                if (week.games && week.games.length > 0) {
                  scheduleHTML += '<div class="text-sm space-y-1">';
                  week.games.forEach(game => {
                    scheduleHTML += `<div class="text-gray-600">${game.opponent}</div>`;
                  });
                  scheduleHTML += '</div>';
                }
                weekDiv.innerHTML = scheduleHTML;
              } else {
                // Past week - show stats
                let statsHTML = `<div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-gray-800">${week.week} (${week.games_count} game${week.games_count !== 1 ? 's' : ''})</h4><span class="text-lg font-bold text-blue-600">${week.fantasy_points} pts</span></div>`;
                statsHTML += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-xs">';
                
                // Show different stats based on position (infer from content)
                if (week.wins > 0 || week.saves > 0) {
                  // Goalie stats
                  statsHTML += `<div><span class="font-semibold">W:</span> ${week.wins}</div>`;
                  statsHTML += `<div><span class="font-semibold">SV:</span> ${week.saves}</div>`;
                  statsHTML += `<div><span class="font-semibold">GA:</span> ${week.goals_against}</div>`;
                  statsHTML += `<div><span class="font-semibold">G:</span> ${week.goals}</div>`;
                  statsHTML += `<div><span class="font-semibold">A:</span> ${week.assists}</div>`;
                } else {
                  // Field player stats
                  statsHTML += `<div><span class="font-semibold">G:</span> ${week.goals}</div>`;
                  statsHTML += `<div><span class="font-semibold">A:</span> ${week.assists}</div>`;
                  statsHTML += `<div><span class="font-semibold">LB:</span> ${week.loose_balls}</div>`;
                  statsHTML += `<div><span class="font-semibold">CT:</span> ${week.caused_turnovers}</div>`;
                  statsHTML += `<div><span class="font-semibold">BS:</span> ${week.blocked_shots}</div>`;
                  statsHTML += `<div><span class="font-semibold">TO:</span> ${week.turnovers}</div>`;
                }
                
                statsHTML += '</div>';
                weekDiv.innerHTML = statsHTML;
              }
              container.appendChild(weekDiv);
            });
          } else {
            container.innerHTML = '<p class="text-gray-500 text-sm">No stats available</p>';
          }
          
          // Show modal
          document.getElementById('playerModal').classList.remove('hidden');
          document.getElementById('playerModal').classList.add('flex');
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to load player details');
        });
    }
    
    function closePlayerModal(event) {
      if (event && event.target.id === 'playerModal') {
        document.getElementById('playerModal').classList.add('hidden');
        document.getElementById('playerModal').classList.remove('flex');
      } else if (!event) {
        document.getElementById('playerModal').classList.add('hidden');
        document.getElementById('playerModal').classList.remove('flex');
      }
    }
  </script>
  {% endif %}
{% endblock %}
