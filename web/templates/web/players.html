{% extends "web/base.html" %}
{% block title %}Players — NLL Fantasy{% endblock %}
{% block content %}
  <div class="container p-2 mx-auto rounded-md sm:p-4 dark:text-gray-800 dark:bg-gray-50">
    <h2 class="mb-3 text-2xl font-semibold leading-tight">Players</h2>

    <div class="flex items-center justify-between mb-4">
      <div>
        {% if selected_season %}
          <h3 class="text-lg font-semibold text-gray-800">
            {{ selected_season }} Season
            {% if selected_week_num %}
              — Week {{ selected_week_num }}
            {% else %}
              — Season Totals
            {% endif %}
          </h3>
        {% endif %}
      </div>
      <form method="get" class="flex items-center gap-3">
        <div>
          <label for="position" class="mr-2 text-sm font-medium">Position:</label>
          <select name="position" id="position" onchange="this.form.submit()" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Runners</option>
            <option value="O" {% if selected_position == 'O' %}selected{% endif %}>Offense</option>
            <option value="D" {% if selected_position == 'D' %}selected{% endif %}>Defense</option>
            <option value="T" {% if selected_position == 'T' %}selected{% endif %}>Transition</option>
            <option value="G" {% if selected_position == 'G' %}selected{% endif %}>Goalie</option>
          </select>
        </div>
        <div>
          <label for="season" class="mr-2 text-sm font-medium">Season:</label>
          <select name="season" id="season" onchange="this.form.submit()" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            {% for s in seasons %}
              <option value="{{ s }}" {% if selected_season and s|stringformat:"s" == selected_season %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="week" class="mr-2 text-sm font-medium">Week:</label>
          <select name="week" id="week" onchange="this.form.submit()" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Weeks</option>
            {% for wk in week_options %}
              <option value="{{ wk.week_number }}" {% if selected_week_num and wk.week_number|stringformat:"s" == selected_week_num %}selected{% endif %}>
                Week {{ wk.week_number }}
              </option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" name="sort" value="{{ sort_field }}">
        <input type="hidden" name="dir" value="{{ sort_dir }}">
        <noscript><button type="submit" class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm">Go</button></noscript>
      </form>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead class="rounded-t-lg dark:bg-gray-300">
          <tr class="text-right">
            {% if user_team %}
            <th title="Roster status" class="p-3" style="width: 80px;"></th>
            <th title="Add player" class="p-3" style="width: 60px;"></th>
            {% endif %}
            <th title="Player name" class="p-3 text-left">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=name&dir={% if sort_field == 'name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                Name
              </a>
            </th>
            <th title="NLL Team" class="p-3 text-left">Team</th>
            <th title="Jersey number" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=number&dir={% if sort_field == 'number' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                #
              </a>
            </th>
            <th title="Position" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=position&dir={% if sort_field == 'position' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                Pos
              </a>
            </th>
            <th title="Games played" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=gp&dir={% if sort_field == 'gp' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                GP
              </a>
            </th>
            <th title="Fantasy points" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=fpts&dir={% if sort_field == 'fpts' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                FPTS
              </a>
            </th>
            {% if selected_position == 'G' %}
            <th title="Wins" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=wins&dir={% if sort_field == 'wins' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                W
              </a>
            </th>
            <th title="Saves" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=saves&dir={% if sort_field == 'saves' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                SV
              </a>
            </th>
            <th title="Goals against" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=ga&dir={% if sort_field == 'ga' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                GA
              </a>
            </th>
            <th title="Save percentage" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=sv_pct&dir={% if sort_field == 'sv_pct' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                SV%
              </a>
            </th>
            <th title="Goals" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=goals&dir={% if sort_field == 'goals' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                G
              </a>
            </th>
            <th title="Assists" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=assists&dir={% if sort_field == 'assists' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                A
              </a>
            </th>
            {% else %}
            <th title="Goals" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=goals&dir={% if sort_field == 'goals' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                G
              </a>
            </th>
            <th title="Assists" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=assists&dir={% if sort_field == 'assists' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                A
              </a>
            </th>
            <th title="Loose balls" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=loose&dir={% if sort_field == 'loose' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                LB
              </a>
            </th>
            <th title="Caused turnovers" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=ct&dir={% if sort_field == 'ct' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                CT
              </a>
            </th>
            <th title="Blocked shots" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=bs&dir={% if sort_field == 'bs' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                BS
              </a>
            </th>
            <th title="Turnovers" class="p-3">
              <a href="?season={{ selected_season }}{% if selected_week_num %}&week={{ selected_week_num }}{% endif %}{% if selected_position %}&position={{ selected_position }}{% endif %}&sort=to&dir={% if sort_field == 'to' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="hover:underline">
                TO
              </a>
            </th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
        {% for item in players %}
          {% with player=item.player stat=item.latest_stat %}
          <tr class="text-right border-b border-opacity-20 dark:border-gray-300 dark:bg-gray-100">
            {% if user_team %}
            <!-- Roster status indicator -->
            <td class="px-2 py-2">
              {% if item.roster_status == 'on_your_team' %}
                <div class="inline-block px-2 py-1 bg-blue-500 text-white rounded text-xs font-semibold whitespace-nowrap" title="On your team">Your Team</div>
              {% elif item.roster_status == 'on_other_team' %}
                <div class="inline-block px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold whitespace-nowrap" title="On {{ item.rostered_team.name }}">Rostered</div>
              {% endif %}
            </td>
            <!-- Add button -->
            <td class="px-2 py-2">
              {% if item.roster_status == 'available' and roster_can_change %}
                <div class="inline-block px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold whitespace-nowrap cursor-pointer hover:bg-green-600"
                  onclick="showReplaceOptions({{ player.id }}, '{{ player.first_name }} {{ player.last_name }}', '{{ player.position }}')"
                  title="Add player">
                  Add
                </div>
              {% endif %}
            </td>
            {% endif %}
            <td class="px-3 py-2 text-left">
              <span class="font-semibold">{{ player.last_name }}, {{ player.first_name }}</span>
            </td>
            <td class="px-3 py-2 text-left">
              <span class="text-xs">{{ player.nll_team|default:"-" }}</span>
            </td>
            <td class="px-3 py-2">
              <span>{{ player.number|default:"-" }}</span>
            </td>
            <td class="px-3 py-2">
              <span>{{ player.get_position_display }}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if item.games_played %}{{ item.games_played }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span class="font-bold">{% if item.fantasy_points %}{{ item.fantasy_points|floatformat:1 }}{% else %}-{% endif %}</span>
            </td>
            {% if selected_position == 'G' %}
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.wins }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.saves }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals_against }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat and stat.saves > 0 %}{% widthratio stat.saves stat.saves|add:stat.goals_against 100 %}%{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.assists }}{% else %}-{% endif %}</span>
            </td>
            {% else %}
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.goals }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.assists }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.loose_balls }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.caused_turnovers }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.blocked_shots }}{% else %}-{% endif %}</span>
            </td>
            <td class="px-3 py-2">
              <span>{% if stat %}{{ stat.turnovers }}{% else %}-{% endif %}</span>
            </td>
            {% endif %}
          </tr>
          {% endwith %}
        {% empty %}
          <tr class="border-b border-opacity-20 dark:border-gray-300 dark:bg-gray-100">
            <td colspan="{% if user_team %}{% if selected_position == 'G' %}14{% else %}14{% endif %}{% else %}{% if selected_position == 'G' %}12{% else %}12{% endif %}{% endif %}" class="px-3 py-2 text-center text-gray-500">No players found.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if user_team %}
  <!-- Modal for selecting player to replace -->
  <div id="replaceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold mb-4">Add <span id="newPlayerName"></span></h3>
      <p class="mb-4 text-sm text-gray-600">Select a player to drop from your roster:</p>
      <div id="replaceOptions" class="space-y-2 mb-4">
        <!-- Options will be populated by JavaScript -->
      </div>
      <button onclick="closeReplaceModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
        Cancel
      </button>
    </div>
  </div>

  <script>
    function showReplaceOptions(newPlayerId, newPlayerName, newPlayerPosition) {
      document.getElementById('newPlayerName').textContent = newPlayerName;
      const optionsDiv = document.getElementById('replaceOptions');
      optionsDiv.innerHTML = '';

      // Get roster for this position
      const roster = {{ user_roster_json|safe }};
      const positionRoster = roster[newPlayerPosition] || [];

      if (positionRoster.length === 0) {
        optionsDiv.innerHTML = '<p class="text-sm text-red-500">No players in this position to replace.</p>';
      } else {
        positionRoster.forEach(player => {
          const button = document.createElement('button');
          button.className = 'w-full px-4 py-2 text-left bg-gray-100 hover:bg-gray-200 rounded border border-gray-300';
          button.textContent = `Drop ${player.first_name} ${player.last_name}`;
          button.onclick = () => swapPlayer(newPlayerId, player.id);
          optionsDiv.appendChild(button);
        });
      }

      document.getElementById('replaceModal').classList.remove('hidden');
      document.getElementById('replaceModal').classList.add('flex');
    }

    function closeReplaceModal() {
      document.getElementById('replaceModal').classList.add('hidden');
      document.getElementById('replaceModal').classList.remove('flex');
    }

    function closeModal(event) {
      if (event.target.id === 'replaceModal') {
        closeReplaceModal();
      }
    }

    function swapPlayer(addPlayerId, dropPlayerId) {
      // Create form and submit
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/teams/{{ user_team.id }}/assign-player/';
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = '{{ csrf_token }}';
      
      const addInput = document.createElement('input');
      addInput.type = 'hidden';
      addInput.name = 'player_id';
      addInput.value = addPlayerId;
      
      const dropInput = document.createElement('input');
      dropInput.type = 'hidden';
      dropInput.name = 'drop_player_id';
      dropInput.value = dropPlayerId;
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'swap';
      
      form.appendChild(csrfInput);
      form.appendChild(addInput);
      form.appendChild(dropInput);
      form.appendChild(actionInput);
      document.body.appendChild(form);
      form.submit();
    }
  </script>
  {% endif %}
{% endblock %}